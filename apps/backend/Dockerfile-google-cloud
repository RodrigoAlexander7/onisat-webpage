# PRODUCTION DOCKERFILE FOR GOOGLE CLOUD RUN
# Using node slim for prisma compatibility
FROM node:22-slim AS builder

# Instalamos openssl (necesario para Prisma en Debian)
RUN apt-get update -y && apt-get install -y openssl

# Create app directory
WORKDIR /app
RUN corepack enable

# Copy package.json and package-lock.json files and install
COPY package*.json pnpm-lock.yaml ./

RUN pnpm install --frozen-lockfile

COPY . .

RUN npx prisma generate

RUN pnpm run build

# RUNNER STAGE 
FROM node:22-slim AS runner

# Instalamos openssl también en la imagen final
RUN apt-get update -y && apt-get install -y openssl

WORKDIR /app
RUN corepack enable

# Copiamos solo lo necesario desde la etapa anterior
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/prisma.config.ts ./prisma.config.ts

# IMPORTANTE: Copiamos el cliente generado
COPY --from=builder /app/generated ./generated
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma

# Google Cloud Run usa el puerto 8080 por defecto
ENV PORT=8080
EXPOSE 8080

# NOTA: En Google Cloud Run, ejecuta las migraciones manualmente o con un Job
# porque Cloud Run puede tener múltiples instancias ejecutándose simultáneamente
# Comando de inicio (solo la app, sin migraciones automáticas)
CMD ["node", "dist/src/main.js"]
